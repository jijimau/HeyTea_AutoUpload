name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            artifact_name: HeyTea-Uploader.exe
            asset_name: HeyTea-Uploader-${{ github.ref_name }}-windows.exe
          - os: macos-15-intel
            platform: macos
            artifact_name: å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…·.app
            asset_name: HeyTea-Uploader-${{ github.ref_name }}-macos.dmg
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          version="${{ github.ref_name }}"
          echo "VERSION=$version" >> $GITHUB_OUTPUT
        else
          version="${{ github.ref_name }}"
          echo "VERSION=$version" >> $GITHUB_OUTPUT
        fi
      shell: bash
    
    - name: Generate version file
      run: |
        echo "__version__ = '${{ steps.get_version.outputs.VERSION }}'" > _version.py
      shell: bash
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable
      if: matrix.platform == 'windows'
      run: |
        $env:APP_VERSION = "${{ steps.get_version.outputs.VERSION }}"
        pyinstaller --onefile --windowed --name="HeyTea-Uploader" --icon=NONE main.py
      shell: pwsh
    
    - name: Build macOS app
      if: matrix.platform == 'macos'
      run: |
        export APP_VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        # æ„å»º x86_64 æ¶æ„çš„åº”ç”¨ï¼ˆå…¼å®¹ Intel å’Œ Apple Silicon Macï¼‰
        pyinstaller --onedir --windowed --name="å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…·" \
          --target-arch=x86_64 \
          --osx-bundle-identifier=com.heytea.upload.tool \
          main.py
        
        # éªŒè¯æ¶æ„
        echo "æ£€æŸ¥åº”ç”¨æ¶æ„:"
        file "dist/å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…·.app/Contents/MacOS/å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…·"
        
        # åˆ›å»º DMG
        APP_NAME="å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…·"
        DMG_NAME="HeyTea-Uploader-${{ steps.get_version.outputs.VERSION }}-macos.dmg"
        DMG_TEMP="${APP_NAME}_temp"
        
        mkdir "$DMG_TEMP"
        cp -R "dist/${APP_NAME}.app" "$DMG_TEMP/"
        ln -s /Applications "$DMG_TEMP/Applications"
        hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_TEMP" -ov -format UDZO "$DMG_NAME"
        rm -rf "$DMG_TEMP"
        mv "$DMG_NAME" dist/
      shell: bash
    
    - name: Rename Windows executable
      if: matrix.platform == 'windows'
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Move-Item -Path "dist/HeyTea-Uploader.exe" -Destination "dist/HeyTea-Uploader-$version-windows.exe"
      shell: pwsh
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -R artifacts/
    
    - name: Prepare files for release
      run: |
        # å°†æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ä»¥ä¾¿äºè®¿é—®
        find artifacts/ -name "*.exe" -exec mv {} . \;
        find artifacts/ -name "*.dmg" -exec mv {} . \;
        ls -la *.exe *.dmg || echo "Some files might not exist"
    
    - name: Get version from tag
      id: get_version
      run: |
        version="${{ github.ref_name }}"
        echo "VERSION=$version" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          HeyTea-Uploader-*-windows.exe
          HeyTea-Uploader-*-macos.dmg
        body: |
          ## å–œèŒ¶æ¯è´´ä¸Šä¼ å·¥å…· ${{ steps.get_version.outputs.VERSION }}
          
          ### åŠŸèƒ½ç‰¹æ€§
          - âœ… çŸ­ä¿¡éªŒè¯ç ç™»å½•
          - âœ… Tokenç›´æ¥ç™»å½•
          - âœ… å›¾ç‰‡é€‰æ‹©ä¸é¢„è§ˆ
          - âœ… ç›´æ¥ä¸Šä¼ å›¾ç‰‡åˆ°å–œèŒ¶æœåŠ¡å™¨
          - âœ… äººæœºéªŒè¯è‡ªåŠ¨å¤„ç†
          
          ### ä¸‹è½½è¯´æ˜
          
          #### Windows ç”¨æˆ·
          - ğŸ“¥ ä¸‹è½½ `HeyTea-Uploader-${{ steps.get_version.outputs.VERSION }}-windows.exe`
          - åŒå‡»è¿è¡Œå³å¯
          - ç³»ç»Ÿè¦æ±‚ï¼šWindows 10/11
          
          #### macOS ç”¨æˆ·  
          - ğŸ“¥ ä¸‹è½½ `HeyTea-Uploader-${{ steps.get_version.outputs.VERSION }}-macos.dmg`
          - åŒå‡» DMG æ–‡ä»¶ï¼Œå°†åº”ç”¨æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          - **æ”¯æŒæ¶æ„**: Intel Mac (x86_64) åŸç”Ÿæ”¯æŒï¼ŒApple Silicon (ARM64) é€šè¿‡ Rosetta 2 è¿è¡Œ
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½®" â†’ "å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
          - ç³»ç»Ÿè¦æ±‚ï¼šmacOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬
          
          ### ä½¿ç”¨è¯´æ˜
          1. ä½¿ç”¨æ‰‹æœºå·ç™»å½•æˆ–Tokenç™»å½•
          2. é€‰æ‹©596x832å°ºå¯¸çš„PNGå›¾ç‰‡
          3. ä¸Šä¼ åˆ°å–œèŒ¶æœåŠ¡å™¨
          4. å¦‚é‡äººæœºéªŒè¯ï¼Œä¼šè‡ªåŠ¨å¼¹å‡ºéªŒè¯çª—å£
          
          ### æ³¨æ„äº‹é¡¹
          - éœ€è¦ç½‘ç»œè¿æ¥
          - macOS ç‰ˆæœ¬ä¸º x86_64 æ¶æ„ï¼ŒIntel Mac åŸç”Ÿè¿è¡Œï¼ŒApple Silicon Mac é€šè¿‡ Rosetta 2 è¿è¡Œ
          - macOS ç‰ˆæœ¬å·²ä¿®å¤éªŒè¯ç çª—å£å‚æ•°ä¼ é€’é—®é¢˜
          - å¦‚æœ‰é—®é¢˜è¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆ
          
          ---
          **å®Œæ•´æºä»£ç **: [GitHub Repository](https://github.com/${{ github.repository }})
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
